"use strict";

function removeVictoryMessage(e) {
    let t = jQuery("#" + e);
    0 == t.length && console.error("htmlVictoryMessage: not found parentDiv = " + t),
    jQuery("#" + e + " .ms-game-msgbox").remove()
}

function htmlVictoryMessage(e, t, n, r=!0) {
    let o = jQuery("#" + t);
    0 == o.length && console.error("htmlVictoryMessage: not found parentDiv = " + o);
    let l = "#" + t + " .ms-game-msgbox";
    var i = jQuery(l);
    if (0 == i.length) {
        let e;
        e = r ? "&#9733; &nbsp;Победа!&nbsp; &#9733;" : "&#x1F622; Увы&hellip; &#x1F622;",
        o.append(function(e) {
            return '<div class="ms-game-msgbox"><p>' + e + "</p></div>"
        }(e)),
        i = jQuery(l)
    }
    0 != i.length ? n : console.error("msgbox NOT found again")
}

function getMousePos(e, t) {
    let n = e.getBoundingClientRect()
      , r = e.width / n.width
      , o = e.height / n.height;
    return {
        x: (t.clientX - n.left) * r,
        y: (t.clientY - n.top) * o
    }
}

var PIXEL_RATIO = function() {
    var e = document.createElement("canvas").getContext("2d");
    return (window.devicePixelRatio || 1) / (e.webkitBackingStorePixelRatio || e.mozBackingStorePixelRatio || e.msBackingStorePixelRatio || e.oBackingStorePixelRatio || e.backingStorePixelRatio || 1)
}();

function createHiDPICanvas(e, t, n) {
    n || (n = PIXEL_RATIO);
    var r = document.createElement("canvas");
    return r.width = e * n,
    r.height = t * n,
    r.style.width = e + "px",
    r.style.height = t + "px",
    r.getContext("2d").setTransform(n, 0, 0, n, 0, 0),
    r
}

function Puzzle15(e, t) {
    var n = {}
      , r = null
      , o = t
      , l = t
      , i = function(e, t) {
        for (var n = Array(e), r = 0; r < n.length; r++)
            n[r] = Array(t);
        return n
    }(o, l)
      , a = jQuery("#" + e)
      , s = "#" + e + " table";

    function c() {
        var t = "table-" + e;
        a.append(function(e, t, n) {
            for (var r = '<table id="' + n + '" class="Puzzle15Solver"><tbody>', o = 0; o < e; o++) {
                r += "<tr>";
                for (var l = 0; l < t; l++)
                    r += "<td></td>";
                r += "</tr>"
            }
            return r += "</tbody></table>"
        }(o, l, t));
        var c = "button-" + e;
        a.append(function(e) {
            return "<button type='button' class='btn' id='" + e + "'>Новая игра</button>"
        }(c)),
        r = document.getElementById(t),
        function() {
            var e = 0;
            for (; e < 100; )
                if (e++,
                t(),
                n())
                    return;
            function t() {
                for (var e = o * l - 1, t = new Array, n = 0; n < e; n++)
                    t[n] = n + 1;
                for (let e = 0; e < i.length; e++)
                    for (let n = 0; n < i[e].length; n++)
                        if (i.length - 1 == e && i[e].length - 1 == n)
                            i[e][n] = 0;
                        else {
                            let r = Math.floor(Math.random() * (t.length - 1 + 1)) + 1
                              , o = t[r - 1];
                            t.splice(r - 1, 1),
                            i[e][n] = o
                        }
            }
            function n() {
                for (var e = 0, t = o * l, n = 0; n < t; n++) {
                    var r = u(i, o, l, n);
                    if (0 != r)
                        for (var a = n + 1; a < t; a++) {
                            var s = u(i, o, l, a);
                            0 != s && (r > s && e++)
                        }
                    else {
                        var c = Math.floor((n + 1) / l);
                        e += c,
                        Math.floor((n + 1) / l)
                    }
                }
                return l % 2 == e % 2 && !(2 == l && 1 == i[0][0] && 2 == i[0][1] && 3 == i[1][0]);
                function u(e, t, n, r) {
                    for (var o = 0, l = 0; l < t; l++)
                        for (var i = 0; i < n; i++) {
                            if (o == r)
                                return e[l][i];
                            o++
                        }
                }
            }
            console.error("cannot create a correct puzzle, iter=" + e)
        }(),
        u(),
        a.find("#" + t + " td").click((function(t) {
            var r = this.cellIndex
              , o = this.parentNode.rowIndex;
            if (0 != i[o][r]) {
                var l = function(e, t) {
                    if (0 == i[e][t])
                        return null;
                    for (var n = 0; n < i[e].length; n++)
                        if (0 == i[e][n])
                            return {
                                row: e,
                                col: n
                            };
                    for (var r = 0; r < i.length; r++)
                        if (0 == i[r][t])
                            return {
                                row: r,
                                col: t
                            };
                    return null
                }(o, r);
                null != l && (function(e, t, n, r) {
                    if (e < n)
                        for (let o = n; o > e; o--)
                            i[o][r] = i[o - 1][t];
                    else if (e > n)
                        for (let o = n; o < e; o++)
                            i[o][r] = i[o + 1][t];
                    else if (t < r)
                        for (let o = r; o > t; o--)
                            i[n][o] = i[e][o - 1];
                    else if (t > r)
                        for (let o = r; o < t; o++)
                            i[n][o] = i[e][o + 1];
                    i[e][t] = 0,
                    u()
                }(o, r, l.row, l.col),
                function() {
                    for (var t = 1, r = 0; r < i.length; r++)
                        for (var o = 0; o < i[r].length; o++)
                            if (i.length - 1 == r && i[r].length - 1 == o) {
                                if (0 != i[r][o])
                                    return alert("problem found"),
                                    !1
                            } else {
                                if (t != i[r][o])
                                    return !1;
                                t++
                            }
                    (function() {
                        htmlVictoryMessage("Ура! Победа!", e, s),
                        null != n.callback && n.callback()
                    }
                    )()
                }())
            }
        }
        )),
        a.find("#" + c).click((function() {
            n.newGame()
        }
        ))
    }

    function u() {
        for (var e = 0; e < i.length; e++)
            for (var t = 0; t < i[e].length; t++) {
                var n = i[e][t]
                  , o = r.rows[e].cells[t];
                o.innerHTML = 0 != n ? "<a class='btn15'>" + n + "</a>" : ""
            }
    }

    return c(),
    n.newGame = function() {
        a.empty(),
        c()
    }
    ,
    n.destructor = function() {
        a.empty()
    }
    ,
    n
}

jQuery(document).ready((function() {
    let e = 3;
    jQuery(".puzzle-15").each((function() {
        if (e++,
        5 < e)
            return;
        new Puzzle15(jQuery(this).attr("id"),e)
    }
    ))
}
));
